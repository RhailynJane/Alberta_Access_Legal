@startuml Lawyer Attestation - Complete Flow
<style>
' Professional Light Theme Configuration - Pure CSS Style
!$color_bg = "#ffffff"
!$color_bg_light = "#f8f9fa"
!$color_bg_lighter = "#e9ecef"
!$color_fg = "#212529"
!$color_fg_muted = "#6c757d"
!$color_primary = "#0066cc"
!$color_primary_light = "#4da6ff"
!$color_success = "#28a745"
!$color_warning = "#856404"
!$color_error = "#dc3545"
!$color_accent = "#6f42c1"

' Root document styling
document {
  BackGroundColor: $color_bg;
  FontColor: $color_fg;
  FontName: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", Arial, sans-serif;
  FontSize: 11;
}

' Sequence diagram specific styling
participant {
  BackGroundColor: $color_bg_light;
  LineColor: $color_primary;
  FontColor: $color_fg;
  FontSize: 10;
  LineThickness: 2;
  RoundCorner: 8;
  Padding: 8;
}

actor {
  BackGroundColor: $color_bg_lighter;
  LineColor: $color_accent;
  FontColor: $color_fg;
  FontSize: 10;
  LineThickness: 2;
}

' Arrow styling
arrow {
  LineColor: $color_success;
  FontColor: $color_warning;
  FontSize: 12;
  LineThickness: 2;
}

' Activation box styling
lifeLine {
  LineColor: $color_primary;
  LineThickness: 2;
}

' Note styling
note {
  BackGroundColor: $color_bg_lighter;
  LineColor: $color_accent;
  FontColor: $color_fg;
  FontSize: 9;
  LineThickness: 1;
  RoundCorner: 6;
  Padding: 6;
}

' Group/Alt styling
group {
  BackGroundColor: $color_bg_light;
  LineColor: $color_primary;
  FontColor: $color_fg;
  FontSize: 10;
  LineThickness: 2;
}
</style>

title Lawyer Attestation - Complete User Flow

actor "âš–ï¸ Lawyer" as Lawyer
participant "ğŸ’» Frontend\n(AttestationForm)" as Frontend
participant "ğŸ”§ Convex API\n(attestations.js)" as API
participant "ğŸ—ï¸ Model Layer\n(model/attestation.js)" as Model
participant "ğŸ›ï¸ Law Society\nAlberta API" as LSA
participant "ğŸ—„ï¸ Database" as DB

note over Lawyer, DB
  **Lawyer Attestation Architecture**
  
  Following Convex best practices with:
  â€¢ **API Layer**: Secure authentication & authorization
  â€¢ **Model Layer**: Business logic & LSA integration
  â€¢ **Row-Level Security**: User owns their attestation
  â€¢ **Audit Trail**: Complete compliance logging
end note

== Phase 1: Lawyer Initiates Attestation ==

Lawyer -> Frontend : ğŸ“ Fill out attestation form
activate Frontend

note right of Frontend
  **Form Data Collected**
  â€¢ Legal name & bar number
  â€¢ Professional standing confirmations
  â€¢ All checkboxes must be true
  â€¢ Digital signature captured
  â€¢ IP address for audit trail
end note

Frontend -> Frontend : ğŸ” Client-side validation\n(required fields, bar format)

alt Form validation passes
  Frontend -> Frontend : âœ… Show "Submitting..." state
else Form validation fails
  Frontend -> Lawyer : âŒ Show validation errors
  note right of Frontend
    **Common Validation Errors:**
    â€¢ "Legal name is required"
    â€¢ "Bar number must be 4-10 characters"
    â€¢ "All confirmations must be checked"
  end note
  Lawyer <-- Frontend : Error displayed
  deactivate Frontend
end

== Phase 2: Submit Attestation ==

Frontend -> API : âœï¸ submitAttestation(formData)
activate API

note right of API
  **API Security Checks**
  â€¢ User must be authenticated
  â€¢ User role must be "lawyer"
  â€¢ Input validation against schema
  â€¢ IP address extraction for audit
end note

API -> API : ğŸ” requireUser()\nCheck authentication
alt User authenticated
  API -> API : ğŸ­ requireLawyer()\nCheck role = "lawyer"
  alt User is lawyer
    API -> API : âœ… Validate attestation data
  else User not lawyer
    API --> Frontend : âŒ "Only lawyers can attest"
    deactivate API
    Frontend -> Lawyer : ğŸš« Show role error
    deactivate Frontend
  end
else User not authenticated  
  API --> Frontend : âŒ "Not authenticated"
  deactivate API
  Frontend -> Lawyer : ğŸ”’ Redirect to login
  deactivate Frontend
end

== Phase 3: Business Logic Processing ==

API -> Model : ğŸ§  validateAttestationRequirements(data)
activate Model

Model -> Model : ğŸ” Validate required fields\n& checkbox confirmations
alt Data validation passes
  Model -> Model : âœ… Check bar number format
else Data validation fails
  Model --> API : âŒ Validation error details
  API --> Frontend : âŒ "Please check all fields"
  deactivate Model
  deactivate API
  Frontend -> Lawyer : ğŸ“ Show field errors
  deactivate Frontend
end

== Phase 4: LSA Verification ==

Model -> LSA : ğŸ›ï¸ verifyLSAStanding(barNumber)
activate LSA

note right of LSA
  **LSA Directory Check**
  â€¢ Validate bar number exists
  â€¢ Check lawyer is in good standing
  â€¢ Verify no disciplinary actions
  â€¢ Currently stubbed (returns true)
end note

LSA -> LSA : ğŸ” Check lawyer directory
alt LSA verification successful
  LSA --> Model : âœ… { verified: true, status: "good" }
  deactivate LSA
else LSA verification fails
  LSA --> Model : âŒ { verified: false, error: "Not found" }
  deactivate LSA
  Model --> API : âš ï¸ LSA verification failed
  API --> Frontend : âŒ "Could not verify with LSA"
  deactivate Model
  deactivate API
  Frontend -> Lawyer : ğŸ›ï¸ Show LSA error
  deactivate Frontend
end

== Phase 5: Database Storage ==

Model -> Model : ğŸ“‹ Check for existing attestation
Model -> DB : ğŸ” getCurrentAttestation(userId)
activate DB
DB --> Model : ğŸ“„ Existing attestation or null
Model -> Model : ğŸ”„ Determine if update or new

Model -> DB : ğŸ’¾ storeAttestation(userId, data)
Model -> DB : ğŸ“ Insert/update attestations table
DB --> Model : âœ… Attestation saved
deactivate DB

== Phase 6: Audit Logging ==

Model -> DB : ğŸ“‹ logAttestationEvent(userId, data)
activate DB

note right of Model
  **Audit Trail Captured**
  â€¢ Event: "attestation_submitted"
  â€¢ Timestamp & IP address
  â€¢ Bar number & legal name
  â€¢ All attestation confirmations
  â€¢ LSA verification result
end note

DB -> DB : ğŸ“ Insert into consentAuditLog
DB --> Model : âœ… Audit log created
deactivate DB

Model --> API : âœ… { success: true, isUpdate: false }
deactivate Model
API --> Frontend : ğŸ‰ Success response
deactivate API

== Phase 7: Success Display ==

Frontend -> Frontend : ğŸŠ Show success state
Frontend -> Frontend : ğŸ”„ Update attestation status

Frontend -> API : ğŸ“Š checkMyAttestationStatus()
activate API
API -> Model : ğŸ“ˆ hasValidAttestation(userId)
activate Model
Model -> DB : ğŸ” Query attestations table
activate DB
DB --> Model : ğŸ“‹ Attestation data
deactivate DB
Model --> API : âœ… { isValid: true, lsaVerified: true }
deactivate Model
API --> Frontend : ğŸ“Š Status data
deactivate API

Frontend -> Lawyer : âœ¨ Display success confirmation
deactivate Frontend

note over Lawyer, DB
  **âœ… Attestation Complete Successfully!**
  
  **What Happened:**
  1. âœ… Form data validated on client & server
  2. âœ… User authentication & lawyer role verified
  3. âœ… Professional standing confirmations checked
  4. âœ… LSA directory verification completed
  5. âœ… Attestation saved with audit trail
  6. âœ… Success confirmation displayed
  
  **Security Measures Applied:**
  â€¢ ğŸ” Authentication required for all operations
  â€¢ ğŸ­ Role-based authorization enforced
  â€¢ ğŸ‘¤ User can only attest for themselves
  â€¢ ğŸ“‹ Complete audit trail maintained
  â€¢ ğŸ›ï¸ External LSA verification performed
  
  **Compliance Features:**
  â€¢ ğŸ“ All actions logged with timestamps
  â€¢ ğŸŒ IP addresses captured for audit
  â€¢ ğŸ“Š Attestation status tracking
  â€¢ ğŸ”„ Update notifications for changes
  â€¢ âš–ï¸ Legal liability acknowledgments
end note

@enduml