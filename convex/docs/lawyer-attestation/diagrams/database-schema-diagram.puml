@startuml Lawyer Validation - Database Schema
<style>
' Professional Light Theme Configuration - Pure CSS Style
!$color_bg = "#ffffff"
!$color_bg_light = "#f8f9fa"
!$color_bg_lighter = "#e9ecef"
!$color_fg = "#212529"
!$color_fg_muted = "#6c757d"
!$color_primary = "#0066cc"
!$color_primary_light = "#4da6ff"
!$color_success = "#28a745"
!$color_warning = "#856404"
!$color_error = "#dc3545"
!$color_accent = "#6f42c1"

' Root document styling
document {
  BackGroundColor: $color_bg;
  FontColor: $color_fg;
  FontName: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", Arial, sans-serif;
  FontSize: 11;
}

' Entity styling
entity {
  BackGroundColor: $color_bg_light;
  LineColor: $color_primary;
  FontColor: $color_fg;
  FontSize: 10;
  LineThickness: 2;
  RoundCorner: 8;
  Padding: 8;
}

' Package styling
package {
  BackGroundColor: $color_bg_lighter;
  LineColor: $color_accent;
  FontColor: $color_fg;
  FontSize: 11;
  LineThickness: 2;
  RoundCorner: 8;
}

' Arrow styling
arrow {
  LineColor: $color_success;
  FontColor: $color_warning;
  FontSize: 9;
  LineThickness: 2;
}

' Note styling
note {
  BackGroundColor: $color_bg_lighter;
  LineColor: $color_accent;
  FontColor: $color_fg;
  FontSize: 9;
  LineThickness: 1;
  RoundCorner: 6;
  Padding: 6;
}
</style>

title Lawyer Attestation System - Database Schema & Relationships

package "Core User Management" as UserCore {
  entity "ğŸ‘¤ users" as Users {
    _id : Id<"users"> <<PK>>
    ====
    name : string?
    image : string? 
    email : string?
    emailVerificationTime : number?
    phone : string?
    phoneVerificationTime : number?
    isAnonymous : boolean?
    ====
    userType : "lawyer" | "end-user" | "admin" <<Required>>
    ====
    firstName : string?
    lastName : string?
    gender : "male" | "female" | "other" | "prefer-not-to-say"?
    dateOfBirth : string?
    legalNeed : string?
    ====
    location : object?
    consent : object?
    lifecycle : object?
    privacyPrefs : object?
    ====
    hasSpouse : boolean?
    hasChildren : boolean?
    employmentStatus : string?
    incomeRange : string?
    legalAreas : string[]?
    urgencyLevel : "urgent" | "soon" | "flexible"?
    legalMatterDescription : string?
    lawyerGenderPreference : "male" | "female" | "no-preference"?
  }
}

package "Professional Attestation System" as AttestationCore {
  entity "âš–ï¸ attestations" as Attestations {
    _id : Id<"attestations"> <<PK>>
    userId : Id<"users"> <<FK>>
    ====
    legalName : string <<Required>>
    barNumber : string <<Required>>
    ====
    isLicensed : boolean <<Required = true>>
    isInGoodStanding : boolean <<Required = true>>
    noDisciplinaryActions : boolean <<Required = true>>
    profileAccurate : boolean <<Required = true>>
    willUpdateOnChange : boolean <<Required = true>>
    understandsLiability : boolean <<Required = true>>
    ====
    attestationText : string?
    attestationVersion : string? = "1.0"
    ipAddress : string?
    digitalSignature : string?
    ====
    lsaVerified : boolean?
    attestedAt : number <<Auto-generated>>
    _creationTime : number <<Auto>>
  }
}

package "Extended Lawyer Information" as LawyerCore {
  entity "ğŸ›ï¸ lawyerProfiles" as LawyerProfiles {
    _id : Id<"lawyerProfiles"> <<PK>>
    userId : Id<"users"> <<FK>>
    ====
    barNumber : string?
    yearsOfExperience : number?
    firm : string?
    bio : string?
    hourlyRate : number?
    ====
    practiceAreas : string[]?
    courts : string[]?
    ====
    matchingCriteria : object?
    ====
    verified : boolean?
    active : boolean?
  }
}

package "Compliance & Audit Trail" as ComplianceCore {
  entity "ğŸ“‹ consentAuditLog" as AuditLog {
    _id : Id<"consentAuditLog"> <<PK>>
    userId : Id<"users"> <<FK>>
    ====
    event : union <<Required>>
    version : string <<Required>>
    timestamp : number <<Required>>
    ipAddress : string?
    userAgent : string?
    ====
    metadata : any?
  }
}

' Relationships - Primary Foreign Keys
Users ||--o{ Attestations : "userId"
Users ||--o{ LawyerProfiles : "userId"
Users ||--o{ AuditLog : "userId"

' Conceptual relationships
Attestations }o--o{ LawyerProfiles : "Professional\nVerification"
Attestations ||--o{ AuditLog : "Tracks attestation\nevents"

note top of Users
  ğŸ‘¤ Users Table - Central Identity
  
  Key Features:
  â€¢ ğŸ” Convex Auth integration
  â€¢ ğŸ­ Role-based access (lawyer/end-user/admin)
  â€¢ ğŸ“‹ PIPA/PIPEDA compliant consent tracking
  â€¢ âš–ï¸ Specialized lawyer onboarding fields
  â€¢ ğŸ  Row-level security via userId
  
  Indexes:
  â€¢ email, by_phone, by_userType
  â€¢ by_deletion (for GDPR compliance)
end note

note right of Attestations
  âš–ï¸ Attestations Table - Professional Verification
  
  Key Features:
  â€¢ ğŸ›ï¸ LSA integration for bar number verification
  â€¢ âœ… All professional confirmations required = true
  â€¢ ğŸ“ Digital attestation with IP tracking
  â€¢ ğŸ”„ Support for updates (isUpdate logic)
  â€¢ ğŸ“Š Complete audit trail via consentAuditLog
  
  Indexes:
  â€¢ by_user (userId) - row-level security
  â€¢ by_barNumber - uniqueness & LSA lookup
  â€¢ by_lsaVerified - verification status queries
end note

note bottom of LawyerProfiles
  ğŸ›ï¸ Lawyer Profiles - Extended Information
  
  Key Features:
  â€¢ ğŸ“‹ Detailed professional information
  â€¢ ğŸ” Matching criteria for client discovery
  â€¢ âœ… Verification status independent of attestation
  â€¢ ğŸ¢ Firm and practice area details
  â€¢ ğŸ’° Rate and service information
  
  Indexes:
  â€¢ by_userId, by_barNumber (uniqueness)
  â€¢ by_practiceAreas, by_active (discovery)
end note

note left of AuditLog
  ğŸ“‹ Consent Audit Log - Compliance Trail
  
  Key Features:
  â€¢ ğŸ“Š Complete attestation event tracking
  â€¢ ğŸŒ IP address & timestamp capture
  â€¢ ğŸ“ Extensible metadata for event context
  â€¢ âš–ï¸ PIPA/PIPEDA compliance support
  â€¢ ğŸ” Forensic audit capabilities
  
  Indexes:
  â€¢ by_user (userId, timestamp) - user audit trail
  â€¢ by_event (event, timestamp) - event analysis
end note

' Data Flow Annotations
note as DataFlow
  ğŸ”„ Attestation Data Flow:
  
  1. User Registration:
  â€¢ User creates account with userType = "lawyer"
  â€¢ Optional lawyerProfile created for discovery
  
  2. Attestation Submission:
  â€¢ Lawyer submits attestation form
  â€¢ Attestation record created with userId reference
  â€¢ Audit log entry created for compliance
  
  3. Verification Process:
  â€¢ LSA API called to verify barNumber
  â€¢ lsaVerified flag updated on attestation
  â€¢ Additional audit log entry if verification fails
  
  4. Profile Integration:
  â€¢ LawyerProfile can reference attestation data
  â€¢ Professional standing influences profile visibility
  â€¢ Matching algorithms consider verification status
  
  ğŸ”’ Security Features:
  â€¢ All queries filtered by userId (row-level security)
  â€¢ Audit log provides complete compliance trail
  â€¢ No cross-user data access possible
  â€¢ Professional information properly segregated
end note

' Schema Validation Rules
note as ValidationRules
  âœ… Schema Validation Rules:
  
  Attestations Table:
  â€¢ userId must reference valid users._id
  â€¢ All boolean fields must be true for valid attestation
  â€¢ barNumber must match Alberta LSA format
  â€¢ legalName must be non-empty string
  â€¢ attestedAt auto-generated on creation
  
  Users Table:
  â€¢ userType must be one of: lawyer, end-user, admin
  â€¢ Only lawyers can create attestation records
  â€¢ Consent object required for PIPA compliance
  â€¢ Email unique across all users (if provided)
  
  LawyerProfiles Table:
  â€¢ userId must reference user with userType = "lawyer"
  â€¢ barNumber should match attestation.barNumber
  â€¢ verified flag independent of attestation.lsaVerified
  â€¢ practiceAreas array supports legal specialties
  
  ConsentAuditLog Table:
  â€¢ Immutable records (no updates allowed)
  â€¢ timestamp required for all entries
  â€¢ metadata flexible for different event types
  â€¢ userId enforces data ownership
end note

@enduml