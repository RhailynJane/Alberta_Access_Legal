@startuml Lawyer Attestation - Security & Authentication Flow
<style>
' Professional Light Theme Configuration - Pure CSS Style
!$color_bg = "#ffffff"
!$color_bg_light = "#f8f9fa"
!$color_bg_lighter = "#e9ecef"
!$color_fg = "#212529"
!$color_fg_muted = "#6c757d"
!$color_primary = "#0066cc"
!$color_primary_light = "#4da6ff"
!$color_success = "#28a745"
!$color_warning = "#856404"
!$color_error = "#dc3545"
!$color_accent = "#6f42c1"

' Root document styling
document {
  BackGroundColor: $color_bg;
  FontColor: $color_fg;
  FontName: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", Arial, sans-serif;
  FontSize: 11;
}

' Activity diagram specific styling
activity {
  BackGroundColor: $color_bg_light;
  LineColor: $color_primary;
  FontColor: $color_fg;
  FontSize: 10;
  LineThickness: 2;
  RoundCorner: 8;
  Padding: 8;
}

' Start/End styling
start {
  BackGroundColor: $color_success;
  LineColor: $color_success;
  FontColor: $color_bg;
  FontSize: 10;
}

end {
  BackGroundColor: $color_error;
  LineColor: $color_error;
  FontColor: $color_bg;
  FontSize: 10;
}

' Decision diamond styling  
diamond {
  BackGroundColor: $color_bg_lighter;
  LineColor: $color_warning;
  FontColor: $color_fg;
  FontSize: 9;
  LineThickness: 2;
}

' Arrow styling
arrow {
  LineColor: $color_primary;
  FontColor: $color_fg;
  FontSize: 9;
  LineThickness: 2;
}

' Note styling
note {
  BackGroundColor: $color_bg_lighter;
  LineColor: $color_accent;
  FontColor: $color_fg;
  FontSize: 9;
  LineThickness: 1;
  RoundCorner: 6;
  Padding: 6;
}

' Partition styling
partition {
  BackGroundColor: $color_bg_light;
  LineColor: $color_accent;
  FontColor: $color_fg;
  FontSize: 10;
  LineThickness: 2;
}
</style>

title Lawyer Attestation - Multi-Layer Security & Authentication Flow

start

:ğŸ‘¤ User arrives at\nattestation page;

partition "ğŸšª Gateway Security - Authentication Layer" {
  if (User has valid session?) then (âŒ No session)
    :ğŸ”’ Redirect to login page;
    note right
      **Authentication Required**
      â€¢ Valid Convex Auth session
      â€¢ JWT token verification
      â€¢ Session expiry check
      â€¢ Secure cookie validation
    end note
    :ğŸ’¾ Save current page URL\nfor post-login redirect;
    stop
  else (âœ… Authenticated)
  endif

  if (Session not expired?) then (âŒ Expired)
    :â° Show "Session expired" message;
    :ğŸ”’ Redirect to login with\nform data preservation;
    stop
  else (âœ… Valid session)
  endif
}

partition "ğŸ­ Role-Based Authorization Layer" {
  :ğŸ” Fetch user profile\nfrom database;
  
  if (User exists in database?) then (âŒ Not found)
    :ğŸš« Show "User not found" error;
    :ğŸ“§ Log security incident;
    stop
  else (âœ… User found)
  endif

  if (User role is "lawyer"?) then (âŒ Wrong role)
    :ğŸš« Show access denied message;
    note right
      **Role Authorization**
      â€¢ Only lawyers can attest
      â€¢ Admin users have read-only access
      â€¢ End-users blocked completely
      â€¢ Role-based UI rendering
    end note
    :ğŸ“§ Log unauthorized access attempt;
    stop
  else (âœ… Is lawyer)
  endif
}

partition "ğŸ  Row-Level Security Layer" {
  :ğŸ“‹ Load attestation form;
  
  if (Loading existing attestation?) then (ğŸ”„ Yes)
    if (Attestation belongs to current user?) then (âŒ Not owner)
      :ğŸš« Block access to other user data;
      note right
        **Data Ownership Protection**
        â€¢ Users can only see own attestations
        â€¢ Admin override for compliance review
        â€¢ Audit log access attempts
        â€¢ Zero data leakage between users
      end note
      :ğŸ“§ Log data access violation;
      stop
    else (âœ… Owner verified)
    endif
  else (ğŸ†• New attestation)
  endif
}

:âœ… User granted access to\nattestation form;

partition "ğŸ“ Form Submission Security" {
  :ğŸ‘©â€âš–ï¸ User submits attestation;
  
  :ğŸ” Re-verify authentication\non submission;
  if (Still authenticated?) then (âŒ Session lost)
    :ğŸ”’ Require re-authentication;
    :ğŸ’¾ Preserve form data;
    stop
  else (âœ… Still valid)
  endif

  :ğŸ­ Re-check lawyer role\non submission;
  if (Still has lawyer role?) then (âŒ Role changed)
    :ğŸš« Reject submission;
    :ğŸ“§ Log role change during session;
    stop
  else (âœ… Still lawyer)
  endif
}

partition "ğŸ“Š Input Validation Security" {
  :ğŸ” Validate input against\nattestation schema;
  
  if (Schema validation passes?) then (âŒ Invalid data)
    :âš ï¸ Return validation errors;
    note right
      **Input Security Measures**
      â€¢ Type-safe validation schemas
      â€¢ XSS prevention & sanitization
      â€¢ SQL injection protection
      â€¢ Length & format constraints
      â€¢ Business rule enforcement
    end note
    stop
  else (âœ… Valid input)
  endif

  :ğŸ§  Business logic validation;
  if (Business rules satisfied?) then (âŒ Rule violation)
    :ğŸ“ Return business rule errors;
    stop
  else (âœ… Rules satisfied)
  endif
}

partition "ğŸ›ï¸ External Verification Security" {
  :ğŸ“ Call LSA verification API;
  
  if (LSA API responds?) then (âŒ Service down)
    :âš ï¸ Mark for manual review;
    note right
      **External Security Validation**
      â€¢ Professional status verification
      â€¢ Bar number authenticity check
      â€¢ Disciplinary action screening
      â€¢ Good standing confirmation
      â€¢ Fallback to manual review
    end note
  else (âœ… LSA verified)
  endif
}

partition "ğŸ’¾ Data Storage Security" {
  :ğŸ“ Store attestation in database;
  
  :ğŸ” Apply row-level security rules;
  note left
    **Storage Security Features**
    â€¢ Encrypted data at rest
    â€¢ User ID association enforced
    â€¢ Atomic database transactions
    â€¢ No direct SQL access
    â€¢ Convex security built-in
  end note
  
  :ğŸ“‹ Log audit event with metadata;
  note left
    **Audit Trail Security**
    â€¢ IP address captured
    â€¢ Timestamp precision
    â€¢ User agent logging
    â€¢ Action type recorded
    â€¢ Immutable audit log
    â€¢ Compliance requirement met
  end note
}

:ğŸ‰ Attestation successfully\nstored with full security;

end

@enduml